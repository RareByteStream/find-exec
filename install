#!/usr/bin/env bash

# LEGAL NOTICE  
# 
# Copyright (c) 2026 Alex Willer (Legal: Enes Güleç)
# (GH: RareByteStream) <enesg.devel@gmail.com> All rights reserved.
# 
# This work is licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#    http://www.apache.org/licenses/LICENSE-2.0
#    https://www.apache.org/licenses/LICENSE-2.0.txt
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.



if [[ "$0" != "${BASH_SOURCE[0]}" ]]; then
  printf "%s" "Cannot run the installer as a sourced script. It has to be a sub-process."$'\n\r'
  return 0
fi


function to-home () {
  if [[ ! -d "$HOME" ]]; then
    printf "%s" "Cannot install to home due to \$HOME not being a directory."$'\n\r'
  fi
  cp "./find-exec.sh" "$HOME/find-exec.sh"
  local line="source $HOME/find-exec.sh 2>/dev/null"
  local brc_path="$HOME/.bashrc"
  local brc_content="$( cat "$brc_path" )"$'\n\r'
  if [[ ! "$brc_content" = *"$line"* ]]; then
    brc_content="$brc_content""$line"" # do not edit!! auto added line #"$'\n\n'
    printf "%s" "$brc_content" > "$brc_path"
  fi
}


function to-system () {
  local paths=( ${PATH//":"/" "} )
  local fn=find-exec.sh
  local target=""
  if (( ${#paths[@]} > 0 )); then
    for path in "${paths[@]}"; do
      if [[ -d "$path" && ! "$path" = *"sbin"* ]]; then
        target="$path/find-exec.sh"
        sudo cp -f --preserve=all ./$fn "$target"
        sudo chmod +x "$target"
        break
      fi
    done
  else
    printf "%s" "Cannot install to system due to \$PATH being empty or not having at least one valid entry."$'\n\r'
    printf "%s" "Try using --custom=/target/dir for manual installation."$'\n\r'
  fi
}


function to-custom () {
  local path="$1"
  local fn=find-exec.sh
  local target=""
  if [[ -d "$path" ]]; then
    target="$path/$fn"
    sudo cp -f --preserve=all "./" "$target" -v
    sudo chmod +x "$target"
  else
    printf "%s" "Cannot install at given path due to it not being a directory."$'\n\r'
  fi
}

args=( $@ )
arg=""

declare -gA will_do
will_do["-rc"]=0
will_do["-sys"]=0
will_do["-c"]=0
will_do["cpath"]=""

for arg in "${args[@]}"; do

  if [[ "$arg" = "-a" ||"$arg" = "--all" ]]; then
    will_do["-rc"]=1
    will_do["-sys"]=1
  fi

  if [[ "$arg" = "-rc"* || "$arg" = "--home"* ]]; then
    will_do["-rc"]=1
  fi

  if [[ "$arg" = "-sys"* || "$arg" = "--sys"* ]]; then
    will_do["-sys"]=1
  fi

  if [[ "$arg" = "-c="* || "$arg" = "--custom="* ]]; then
    will_do["-c"]=1
    path="$arg"
    path="${path/"--custom="/""}"
    path="${path/"-c="/""}"
    will_do["cpath"]="$path"
  fi

done


if [[ "${will_do["-rc"]}" -eq 1 ]]; then
  to-home
fi

if [[ "${will_do["-sys"]}" -eq 1 ]]; then
  to-system
fi

if [[ "${will_do["-c"]}" -eq 1 ]]; then
  to-custom "${will_do["cpath"]}"
fi


